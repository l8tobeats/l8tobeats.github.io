<script>
    // Mettez bien votre URL de production ngrok + webhook ici !
const n8nWebhookUrl = 'https://cors-anywhere.herokuapp.com/https://155e1ec42649.ngrok-free.app/webhook/4ff7a4c1-bf00-42d0-acb4-11c8cb26d5dc';

    const createButton = document.getElementById('createButton');
    const statusDiv = document.getElementById('status');
    const resultDiv = document.getElementById('result');

    createButton.addEventListener('click', async () => {
        const audioFile = document.getElementById('audioFile').files[0];
        const imageFile = document.getElementById('imageFile').files[0];

        if (!audioFile || !imageFile) {
            statusDiv.innerText = '⚠️ Please select both an audio and an image file.';
            return;
        }

        createButton.disabled = true;
        statusDiv.innerText = 'Uploading and processing... This can take a few moments.';
        resultDiv.innerHTML = '';

        const formData = new FormData();
        formData.append('files0', audioFile);
        formData.append('files1', imageFile);

        try {
            const response = await fetch(n8nWebhookUrl, {
                method: 'POST',
                body: formData
            });

            if (!response.ok) {
                // Essayer de lire l'erreur renvoyée par n8n
                const errorText = await response.text();
                throw new Error(`Server error (${response.status}): ${errorText}`);
            }
            
            statusDiv.innerText = '✅ Conversion successful! Preparing download...';

            // === LA PARTIE MAGIQUE EST ICI ===
            // 1. On reçoit la réponse comme un fichier binaire (Blob)
            const videoBlob = await response.blob();
            
            // 2. On crée une URL temporaire dans le navigateur pour ce fichier
            const videoUrl = URL.createObjectURL(videoBlob);

            // 3. On crée un lien de téléchargement invisible et on le configure
            const downloadLink = document.createElement('a');
            downloadLink.href = videoUrl;
            // On nomme le fichier de sortie comme le fichier audio, mais en .mp4
            downloadLink.download = audioFile.name.replace(/\.[^/.]+$/, '.mp4');
            downloadLink.innerText = '⬇️ Download Your Video';
            
            // 4. On ajoute le lien visible à la page
            resultDiv.appendChild(downloadLink);
            statusDiv.innerText = 'Your video is ready!';

        } catch (error) {
            statusDiv.innerText = '❌ An error occurred. Please check the files and try again.';
            console.error(error); // Affiche l'erreur détaillée dans la console (F12)
        } finally {
            createButton.disabled = false;
        }
    });
</script>